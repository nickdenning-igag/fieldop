<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FieldOps Router</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;500;600;700;800&family=Barlow+Semi+Condensed:wght@300;400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #f2f5fb;
  --surface:   #ffffff;
  --surface2:  #f8fafd;
  --border:    #e1e8f4;
  --border2:   #c8d4e8;
  --muted:     #7a88a4;
  --body:      #374259;
  --heading:   #111827;
  --amber:     #f59e0b;
  --amber2:    #fbbf24;
  --amber-pale:#fef9ec;
  --amber-dim: rgba(245,158,11,0.10);
  --amber-bdr: rgba(245,158,11,0.32);
  --green:     #059669;
  --green-pale:#ecfdf5;
  --green-dim: rgba(5,150,105,0.09);
  --green-bdr: rgba(5,150,105,0.28);
  --red:       #dc2626;
  --red-dim:   rgba(220,38,38,0.08);
  --red-bdr:   rgba(220,38,38,0.25);
  --blue:      #2563eb;
  --blue-dim:  rgba(37,99,235,0.08);
  --blue-bdr:  rgba(37,99,235,0.28);
  --shadow-xs: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-sm: 0 1px 4px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.04);
  --shadow:    0 4px 14px rgba(0,0,0,0.09), 0 1px 3px rgba(0,0,0,0.05);
  --shadow-lg: 0 12px 36px rgba(0,0,0,0.13), 0 3px 8px rgba(0,0,0,0.06);
  --r: 8px; --r2: 12px; --r3: 16px;
}

body {
  font-family: 'Share Tech Mono', monospace;
  background: var(--bg);
  color: var(--body);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ‚îÄ BACKGROUND ‚îÄ‚îÄ‚îÄ */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background:
    radial-gradient(ellipse 75% 55% at 5% 0%,   rgba(245,158,11,0.08) 0%, transparent 55%),
    radial-gradient(ellipse 55% 45% at 95% 100%, rgba(37,99,235,0.05)  0%, transparent 50%),
    repeating-linear-gradient(0deg,  transparent, transparent 47px, rgba(0,0,0,0.016) 48px),
    repeating-linear-gradient(90deg, transparent, transparent 47px, rgba(0,0,0,0.016) 48px);
  pointer-events: none;
}

.app {
  position: relative; z-index: 1;
  max-width: 1320px; margin: 0 auto; padding: 0 28px 60px;
}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 22px 0; margin-bottom: 26px;
  border-bottom: 2px solid var(--border);
  position: relative;
}
header::after {
  content: ''; position: absolute; bottom: -2px; left: 0;
  width: 280px; height: 2px;
  background: linear-gradient(90deg, var(--amber) 0%, transparent 100%);
}

.header-left { display: flex; align-items: center; gap: 16px; }

.logo-mark {
  width: 46px; height: 46px;
  background: linear-gradient(135deg, var(--amber), #e8920a);
  clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  box-shadow: 0 4px 16px rgba(245,158,11,0.40);
  animation: logoPulse 4s ease-in-out infinite;
}
@keyframes logoPulse {
  0%,100% { box-shadow: 0 4px 16px rgba(245,158,11,0.40); }
  50%      { box-shadow: 0 4px 26px rgba(245,158,11,0.60); }
}
.logo-mark svg { width: 22px; height: 22px; fill: #fff; }
.logo-text { line-height: 1; }
.logo-main {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 2rem; font-weight: 800; letter-spacing: 0.03em;
  color: var(--heading); line-height: 0.95;
}
.logo-main span { color: var(--amber); }
.logo-sub {
  font-size: 0.57rem; letter-spacing: 0.22em; color: var(--muted);
  text-transform: uppercase; margin-top: 4px; display: block;
}

.header-right { display: flex; align-items: center; gap: 20px; }

.status-pill {
  display: flex; align-items: center; gap: 8px;
  background: var(--surface); border: 1.5px solid var(--border);
  border-radius: 100px; padding: 7px 16px;
  font-size: 0.61rem; letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--muted); box-shadow: var(--shadow-xs);
}
.status-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 0 3px rgba(5,150,105,0.18);
  animation: blink 2.5s ease-in-out infinite;
}
@keyframes blink { 0%,100%{opacity:1;box-shadow:0 0 0 3px rgba(5,150,105,0.18)} 50%{opacity:0.6;box-shadow:0 0 0 5px rgba(5,150,105,0.08)} }

.header-stat { text-align: right; }
.header-stat-num {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 2rem; font-weight: 800; color: var(--amber); line-height: 1;
}
.header-stat-label {
  font-size: 0.57rem; letter-spacing: 0.16em; color: var(--muted); text-transform: uppercase;
}

/* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
.layout { display: grid; grid-template-columns: 365px 1fr; gap: 22px; align-items: start; }

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
.sidebar {
  background: var(--surface); border: 1.5px solid var(--border);
  border-radius: var(--r3); overflow: hidden;
  position: sticky; top: 20px; box-shadow: var(--shadow);
}
.sidebar-header { padding: 20px 24px 16px; border-bottom: 1.5px solid var(--border); }

/* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
.tabs { display: flex; background: var(--surface2); border-bottom: 1.5px solid var(--border); }
.tab {
  flex: 1; padding: 13px 8px;
  border: none; background: none;
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.62rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--muted); cursor: pointer; transition: all 0.2s;
  border-bottom: 2.5px solid transparent; margin-bottom: -1.5px;
}
.tab:hover { color: var(--body); background: rgba(0,0,0,0.02); }
.tab.active { color: var(--amber); border-bottom-color: var(--amber); background: var(--surface); font-weight: 700; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.form-body { padding: 20px 22px 24px; }

/* ‚îÄ‚îÄ‚îÄ SECTION LABELS ‚îÄ‚îÄ‚îÄ */
.section-label {
  display: flex; align-items: center; gap: 9px;
  font-size: 0.57rem; letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--muted); margin-bottom: 10px; margin-top: 20px;
}
.section-label::before {
  content: ''; display: block; width: 3px; height: 13px;
  background: linear-gradient(180deg, var(--amber), #e8920a);
  border-radius: 2px; flex-shrink: 0;
}
.section-label:first-child { margin-top: 0; }

/* ‚îÄ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ‚îÄ */
.field { margin-bottom: 13px; }
.field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 13px; }

label {
  display: block; font-size: 0.57rem; letter-spacing: 0.15em;
  text-transform: uppercase; color: var(--muted); margin-bottom: 5px; font-weight: 600;
}

input[type="text"], input[type="date"], select, textarea {
  width: 100%; background: var(--surface2); border: 1.5px solid var(--border);
  border-radius: var(--r); padding: 9px 12px;
  font-family: 'Share Tech Mono', monospace; font-size: 0.76rem; color: var(--heading);
  outline: none; transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
  appearance: none;
}
input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
  border-color: var(--amber); background: #fff;
  box-shadow: 0 0 0 3px rgba(245,158,11,0.13);
}
textarea { resize: vertical; min-height: 56px; }
::placeholder { color: var(--muted); opacity: 0.55; }
select option { background: #fff; color: var(--heading); }

/* ‚îÄ‚îÄ‚îÄ SLIDER ‚îÄ‚îÄ‚îÄ */
.slider-wrap { margin-top: 4px; }
.slider-row { display: flex; align-items: center; gap: 12px; }
input[type="range"] {
  flex: 1; appearance: none; height: 4px;
  background: linear-gradient(90deg, var(--amber) 0%, var(--border) 0%);
  border-radius: 2px; outline: none; cursor: pointer;
}
input[type="range"]::-webkit-slider-thumb {
  appearance: none; width: 18px; height: 18px;
  background: var(--amber); border-radius: 50%; cursor: pointer;
  box-shadow: 0 1px 4px rgba(245,158,11,0.45), 0 0 0 3px rgba(245,158,11,0.12);
  transition: transform 0.15s, box-shadow 0.15s;
}
input[type="range"]::-webkit-slider-thumb:hover {
  transform: scale(1.2); box-shadow: 0 2px 8px rgba(245,158,11,0.55), 0 0 0 5px rgba(245,158,11,0.12);
}
.slider-val {
  min-width: 115px; text-align: right;
  font-family: 'Barlow Condensed', sans-serif; font-size: 0.95rem; font-weight: 700;
  color: var(--amber); line-height: 1; white-space: nowrap;
}
.slider-labels { display: flex; justify-content: space-between; margin-top: 5px; }
.slider-labels span { font-size: 0.51rem; letter-spacing: 0.08em; color: var(--muted); text-transform: uppercase; }

/* ‚îÄ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ‚îÄ */
.tag-group { display: flex; flex-wrap: wrap; gap: 6px; }
.tag {
  padding: 5px 11px; border-radius: 100px;
  border: 1.5px solid var(--border2); background: var(--surface2);
  font-size: 0.62rem; font-family: 'Share Tech Mono', monospace; color: var(--muted);
  cursor: pointer; transition: all 0.15s; user-select: none;
}
.tag:hover { border-color: var(--amber); color: #92400e; background: var(--amber-pale); }
.tag.selected { background: var(--amber-pale); border-color: var(--amber); color: #92400e; font-weight: 600; }
.tag.selected.drive { background: #eff6ff; border-color: #3b82f6; color: #1e40af; }
.tag.selected.pos  { background: var(--green-pale); border-color: var(--green); color: #065f46; font-weight: 600; }
.tag.aci { border-color: var(--blue-bdr); color: var(--blue); background: var(--blue-dim); }
.tag.aci.selected { background: #dbeafe; border-color: var(--blue); color: #1e3a8a; }

/* ‚îÄ‚îÄ‚îÄ PRIMARY BUTTON ‚îÄ‚îÄ‚îÄ */
.btn-primary {
  width: 100%; padding: 13px;
  background: linear-gradient(135deg, var(--amber) 0%, #e8920a 100%);
  border: none; border-radius: var(--r2);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 1.1rem; font-weight: 800; letter-spacing: 0.1em; color: #fff;
  cursor: pointer; transition: all 0.2s; margin-top: 20px;
  box-shadow: 0 4px 16px rgba(245,158,11,0.38);
  position: relative; overflow: hidden;
}
.btn-primary::after {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.15), transparent);
  opacity: 0; transition: opacity 0.2s;
}
.btn-primary:hover::after { opacity: 1; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 22px rgba(245,158,11,0.50); }
.btn-primary:active { transform: translateY(0); }

/* ‚îÄ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ‚îÄ */
.right-panel { display: flex; flex-direction: column; gap: 20px; }

/* ‚îÄ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ‚îÄ */
.results-panel { display: none; background: var(--surface); border: 1.5px solid var(--border); border-radius: var(--r3); overflow: hidden; box-shadow: var(--shadow); }
.results-panel.show { display: block; }
.results-header {
  padding: 16px 20px; border-bottom: 1.5px solid var(--border);
  display: flex; align-items: center; gap: 12px;
  background: linear-gradient(90deg, var(--amber-pale), var(--surface2));
}
.results-title { font-family: 'Barlow Condensed', sans-serif; font-size: 1rem; font-weight: 700; letter-spacing: 0.08em; color: var(--heading); }
.results-title span { color: var(--amber); }
.results-body { padding: 14px; display: flex; flex-direction: column; gap: 10px; }
.result-item {
  display: flex; align-items: center; gap: 14px;
  padding: 14px 16px; background: var(--surface2);
  border: 1.5px solid var(--border); border-radius: var(--r2);
  transition: all 0.2s; box-shadow: var(--shadow-xs);
  animation: fadeUp 0.35s ease forwards; opacity: 0; transform: translateY(10px);
}
.result-item:hover { border-color: var(--amber-bdr); box-shadow: var(--shadow); background: #fff; transform: translateY(-1px); }
@keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
.result-item:nth-child(1){animation-delay:.00s}
.result-item:nth-child(2){animation-delay:.07s}
.result-item:nth-child(3){animation-delay:.14s}
.result-item:nth-child(4){animation-delay:.21s}

.match-badge {
  min-width: 62px; height: 62px; border-radius: var(--r2);
  display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0;
}
.match-badge.high { background: var(--green-pale); border: 1.5px solid var(--green-bdr); }
.match-badge.med  { background: var(--amber-pale); border: 1.5px solid var(--amber-bdr); }
.match-badge.low  { background: var(--red-dim);    border: 1.5px solid var(--red-bdr); }
.match-pct { font-family: 'Barlow Condensed', sans-serif; font-size: 1.6rem; font-weight: 800; line-height: 1; }
.match-badge.high .match-pct { color: var(--green); }
.match-badge.med  .match-pct { color: var(--amber); }
.match-badge.low  .match-pct { color: var(--red); }
.match-label { font-size: 0.47rem; letter-spacing: 0.12em; color: var(--muted); text-transform: uppercase; margin-top: 2px; }
.result-info { flex: 1; min-width: 0; }
.result-name { font-family: 'Barlow Semi Condensed', sans-serif; font-weight: 600; font-size: 0.92rem; color: var(--heading); margin-bottom: 3px; }
.result-reasons { font-size: 0.61rem; color: var(--muted); line-height: 1.65; }
.result-meta { font-size: 0.59rem; color: var(--muted); margin-top: 5px; display: flex; gap: 12px; flex-wrap: wrap; }
.btn-assign {
  padding: 9px 18px; background: var(--amber);
  border: none; border-radius: var(--r);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 0.85rem; font-weight: 700; letter-spacing: 0.08em;
  color: #fff; cursor: pointer; transition: all 0.2s; white-space: nowrap;
  box-shadow: 0 2px 8px rgba(245,158,11,0.35);
}
.btn-assign:hover { background: #e8920a; box-shadow: 0 4px 14px rgba(245,158,11,0.50); transform: translateY(-1px); }

/* ‚îÄ‚îÄ‚îÄ MAP ‚îÄ‚îÄ‚îÄ */
.map-panel { background: var(--surface); border: 1.5px solid var(--border); border-radius: var(--r3); overflow: hidden; box-shadow: var(--shadow); }
.map-header {
  padding: 16px 20px; border-bottom: 1.5px solid var(--border);
  display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; flex-wrap: wrap;
  background: var(--surface2);
}
.panel-heading { display: flex; align-items: center; gap: 10px; }
.panel-heading-icon {
  width: 32px; height: 32px; border-radius: var(--r);
  background: var(--amber-pale); border: 1.5px solid var(--amber-bdr);
  display: flex; align-items: center; justify-content: center; font-size: 0.9rem;
  box-shadow: var(--shadow-xs);
}
.panel-heading-title { font-family: 'Barlow Condensed', sans-serif; font-size: 1rem; font-weight: 700; letter-spacing: 0.08em; color: var(--heading); }
.map-legend { display: flex; flex-wrap: wrap; gap: 7px; align-items: center; }
.legend-item {
  display: flex; align-items: center; gap: 6px;
  font-size: 0.59rem; letter-spacing: 0.05em; color: var(--body);
  background: var(--surface); border: 1.5px solid var(--border);
  border-radius: 100px; padding: 4px 10px; box-shadow: var(--shadow-xs);
}
.legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

#us-map-wrap { position: relative; background: #edf2fb; border-top: 1.5px solid var(--border); aspect-ratio: 960 / 560; }
#us-map-wrap svg { width: 100%; height: 100%; display: block; }
.state-fill { transition: fill 0.2s; }
.state-fill:hover { fill: #d2deef !important; }
.state-path { fill: #dce8f5; stroke: #b8cce0; stroke-width: 0.8; transition: fill 0.2s; cursor: default; }
.state-path:hover { fill: #c8daee; }
.map-pin { cursor: pointer; }
.map-pin:hover .pin-main { filter: brightness(1.1) drop-shadow(0 2px 6px rgba(0,0,0,0.25)); }
.pin-pulse { animation: mapPulse 2.2s ease-in-out infinite; transform-box: fill-box; transform-origin: center; }
@keyframes mapPulse { 0%,100%{opacity:0.4;transform:scale(1)} 50%{opacity:0;transform:scale(2.8)} }

#map-tooltip {
  position: absolute; pointer-events: none;
  background: #fff; border: 1.5px solid var(--border2);
  border-radius: var(--r2); padding: 12px 16px;
  font-size: 0.67rem; max-width: 250px; box-shadow: var(--shadow-lg);
  display: none; z-index: 10; line-height: 1.8;
}
.tt-proj { font-family: 'Barlow Condensed', sans-serif; font-size: 1rem; font-weight: 700; letter-spacing: 0.06em; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1.5px solid var(--border); color: var(--heading); }
.tt-row { display: flex; gap: 8px; align-items: baseline; }
.tt-key { color: var(--muted); font-size: 0.56rem; letter-spacing: 0.12em; text-transform: uppercase; min-width: 52px; }
.tt-val { color: var(--body); font-size: 0.65rem; }

/* ‚îÄ‚îÄ‚îÄ PROJECT CARDS ‚îÄ‚îÄ‚îÄ */
.proj-panel { background: var(--surface); border: 1.5px solid var(--border); border-radius: var(--r3); overflow: hidden; box-shadow: var(--shadow); }
.proj-panel-header {
  padding: 16px 20px; border-bottom: 1.5px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; background: var(--surface2);
}
.proj-count-badge {
  font-family: 'Barlow Condensed', sans-serif; font-size: 0.88rem; font-weight: 700;
  letter-spacing: 0.08em; color: #92400e;
  background: var(--amber-pale); border: 1.5px solid var(--amber-bdr); border-radius: 100px; padding: 3px 13px;
}
.projects-grid { padding: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

.project-card {
  background: #fff; border: 1.5px solid var(--border); border-radius: var(--r2);
  overflow: hidden; transition: all 0.2s; position: relative; box-shadow: var(--shadow-sm);
}
.project-card:hover { border-color: var(--amber-bdr); box-shadow: var(--shadow-lg); transform: translateY(-2px); }
.card-stripe { height: 4px; }
.card-body { padding: 14px 16px; }
.card-name { font-family: 'Barlow Semi Condensed', sans-serif; font-weight: 700; font-size: 0.93rem; color: var(--heading); margin-bottom: 5px; }
.card-desc { font-size: 0.63rem; color: var(--muted); line-height: 1.55; margin-bottom: 10px; }
.card-info-row { display: flex; align-items: center; gap: 6px; font-size: 0.61rem; color: var(--muted); margin-bottom: 4px; }
.card-info-row svg { width: 11px; height: 11px; fill: currentColor; flex-shrink: 0; }
.card-info-row strong { color: var(--body); font-weight: 500; }
.card-chips { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; margin-bottom: 12px; }
.chip { font-size: 0.54rem; padding: 3px 8px; border-radius: 100px; letter-spacing: 0.05em; text-transform: uppercase; border: 1.5px solid; font-weight: 600; }
.chip-skill { border-color: var(--green-bdr); color: #065f46; background: var(--green-pale); }
.chip-level { border-color: var(--border2);   color: var(--muted); background: var(--surface2); }
.chip-trait { border-color: var(--amber-bdr); color: #92400e; background: var(--amber-pale); }
.card-footer {
  padding: 10px 16px; border-top: 1.5px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; background: var(--surface2);
}
.avatars { display: flex; align-items: center; }
.avatar {
  width: 26px; height: 26px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.54rem; font-weight: 700; color: #fff;
  border: 2px solid #fff; margin-left: -6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.12);
}
.avatar:first-child { margin-left: 0; }
.avatar-count { font-size: 0.6rem; color: var(--muted); margin-left: 8px; }
.card-actions { display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; }
.project-card:hover .card-actions { opacity: 1; }
.icon-btn {
  width: 28px; height: 28px; border-radius: var(--r);
  border: 1.5px solid var(--border); background: var(--surface2);
  color: var(--muted); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.72rem; transition: all 0.15s;
}
.icon-btn:hover { color: var(--heading); border-color: var(--border2); background: #fff; }
.icon-btn.del:hover { border-color: var(--red-bdr); color: var(--red); background: var(--red-dim); }

/* ‚îÄ‚îÄ‚îÄ PEOPLE ‚îÄ‚îÄ‚îÄ */
.people-panel { background: var(--surface); border: 1.5px solid var(--border); border-radius: var(--r3); overflow: hidden; box-shadow: var(--shadow); }
.people-panel-header {
  padding: 16px 20px; border-bottom: 1.5px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; background: var(--surface2);
}
.people-count-badge {
  font-family: 'Barlow Condensed', sans-serif; font-size: 0.88rem; font-weight: 700;
  letter-spacing: 0.08em; color: #065f46;
  background: var(--green-pale); border: 1.5px solid var(--green-bdr); border-radius: 100px; padding: 3px 13px;
}
.people-body { padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; }
.person-row {
  display: flex; align-items: center; gap: 14px;
  padding: 12px 14px; background: #fff;
  border: 1.5px solid var(--border); border-radius: var(--r2);
  transition: all 0.2s; box-shadow: var(--shadow-xs);
  animation: fadeUp 0.3s ease forwards; opacity: 0; transform: translateY(8px);
}
.person-row:hover { border-color: var(--green-bdr); box-shadow: var(--shadow); transform: translateY(-1px); }
.person-avatar {
  width: 40px; height: 40px; border-radius: var(--r);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Barlow Condensed', sans-serif; font-size: 1rem; font-weight: 700;
  color: #fff; flex-shrink: 0;
}
.person-info { flex: 1; min-width: 0; }
.person-name { font-family: 'Barlow Semi Condensed', sans-serif; font-weight: 600; font-size: 0.88rem; color: var(--heading); margin-bottom: 2px; }
.person-meta { font-size: 0.59rem; color: var(--muted); line-height: 1.5; }
.person-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; text-align: right; }
.person-proj-tag {
  font-size: 0.59rem; padding: 4px 10px; border-radius: 100px;
  border: 1.5px solid var(--green-bdr); color: #065f46;
  background: var(--green-pale); font-weight: 600; white-space: nowrap;
}
.person-date-tag { font-size: 0.57rem; color: var(--muted); white-space: nowrap; }

/* ‚îÄ‚îÄ‚îÄ EMPTY STATES ‚îÄ‚îÄ‚îÄ */
.empty { text-align: center; padding: 48px 20px; }
.empty-icon { font-size: 2.4rem; margin-bottom: 14px; opacity: 0.3; }
.empty-text { font-size: 0.7rem; line-height: 1.9; color: var(--muted); }

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0; z-index: 100;
  background: rgba(10,15,35,0.45); backdrop-filter: blur(6px);
  display: none; align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: #fff; border: 1.5px solid var(--border);
  border-radius: var(--r3); padding: 28px; width: 100%; max-width: 480px;
  animation: modalPop 0.22s cubic-bezier(0.34,1.56,0.64,1);
  max-height: 92vh; overflow-y: auto;
  box-shadow: 0 24px 60px rgba(0,0,0,0.18);
}
@keyframes modalPop { from{opacity:0;transform:scale(0.93) translateY(10px)} to{opacity:1;transform:scale(1) translateY(0)} }
.modal-title {
  font-family: 'Barlow Condensed', sans-serif; font-size: 1.4rem; font-weight: 800;
  letter-spacing: 0.08em; color: var(--heading); margin-bottom: 22px;
  padding-bottom: 14px; border-bottom: 1.5px solid var(--border);
}
.modal-actions { display: flex; gap: 10px; margin-top: 22px; }
.btn-cancel {
  flex: 1; padding: 11px; background: var(--surface2);
  border: 1.5px solid var(--border); border-radius: var(--r);
  font-family: 'Share Tech Mono', monospace; font-size: 0.68rem; font-weight: 600;
  letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); cursor: pointer; transition: all 0.2s;
}
.btn-cancel:hover { color: var(--heading); border-color: var(--border2); background: #fff; }
.btn-save {
  flex: 2; padding: 11px; background: linear-gradient(135deg, var(--amber), #e8920a);
  border: none; border-radius: var(--r);
  font-family: 'Barlow Condensed', sans-serif; font-size: 1rem; font-weight: 800;
  letter-spacing: 0.1em; color: #fff; cursor: pointer; transition: all 0.2s;
  box-shadow: 0 3px 10px rgba(245,158,11,0.35);
}
.btn-save:hover { box-shadow: 0 5px 18px rgba(245,158,11,0.50); transform: translateY(-1px); }

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.toast {
  position: fixed; bottom: 28px; right: 28px; z-index: 200;
  background: #fff; border-radius: var(--r2); padding: 13px 20px;
  font-size: 0.7rem; display: flex; align-items: center; gap: 10px;
  transform: translateY(80px); opacity: 0;
  transition: all 0.35s cubic-bezier(0.34,1.56,0.64,1);
  pointer-events: none; max-width: 320px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.14); border: 1.5px solid var(--border);
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast-icon { font-size: 1rem; flex-shrink: 0; }
.toast-msg { color: var(--heading); }

/* ‚îÄ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ‚îÄ */
.divider { border: none; border-top: 1.5px solid var(--border); margin: 16px 0; }

@media (max-width: 960px) {
  .layout { grid-template-columns: 1fr; }
  .sidebar { position: static; }
  .projects-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="app">
  <!-- HEADER -->
  <header>
    <div class="header-left">
      <div class="logo-mark">
        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      </div>
      <div class="logo-text">
        <div class="logo-main">Field<span>Ops</span> Router</div>
        <span class="logo-sub">Concrete Testing &amp; QC Dispatch</span>
      </div>
    </div>
    <div class="header-right">
      <div class="status-pill"><div class="status-dot"></div>System Active</div>
      <button onclick="resetData()" style="padding:7px 14px;background:var(--surface);border:1.5px solid var(--border);border-radius:100px;font-family:'Share Tech Mono',monospace;font-size:0.59rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);cursor:pointer;transition:all 0.2s;box-shadow:var(--shadow-xs);" onmouseover="this.style.color='var(--red)';this.style.borderColor='var(--red-bdr)'" onmouseout="this.style.color='var(--muted)';this.style.borderColor='var(--border)'">‚Ü∫ Reset</button>
      <div class="header-stat">
        <div class="header-stat-num" id="h-proj">3</div>
        <div class="header-stat-label">Active Projects</div>
      </div>
      <div class="header-stat">
        <div class="header-stat-num" id="h-people">0</div>
        <div class="header-stat-label">Deployed</div>
      </div>
    </div>
  </header>

  <div class="layout">
    <!-- ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ -->
    <div class="sidebar">
      <div class="tabs">
        <button class="tab active" data-tab="route">Route Person</button>
        <button class="tab" data-tab="project">Add Project</button>
      </div>

      <!-- ROUTE TAB -->
      <div id="tab-route" class="tab-content active">
        <div class="form-body">
          <div class="section-label">Technician Info</div>
          <div class="field">
            <label>Full Name</label>
            <input type="text" id="r-name" placeholder="e.g. Marcus Webb">
          </div>
          <div class="field">
            <label>Position</label>
            <select id="r-position">
              <option value="">Select position...</option>
              <option>Lead Field Technician</option>
              <option>Field Technician</option>
            </select>
          </div>
          <div class="field">
            <label>Skill Level</label>
            <div class="slider-wrap">
              <div class="slider-row">
                <input type="range" id="r-skill" min="1" max="5" value="3" oninput="updateSlider(this)">
                <span class="slider-val" id="r-skill-val">3</span>
              </div>
              <div class="slider-labels"><span>Helping Out</span><span>Leading Project</span><span>No Help Needed</span></div>
            </div>
          </div>

          <div class="section-label">Drive &amp; Willingness</div>
          <div class="field">
            <div class="tag-group" id="personality-tags">
              <div class="tag drive" onclick="toggleTag(this)">Self-Starter</div>
              <div class="tag drive" onclick="toggleTag(this)">Team Player</div>
              <div class="tag drive" onclick="toggleTag(this)">Takes Initiative</div>
              <div class="tag drive" onclick="toggleTag(this)">Follows Direction</div>
              <div class="tag drive" onclick="toggleTag(this)">Highly Motivated</div>
              <div class="tag drive" onclick="toggleTag(this)">Needs Guidance</div>
              <div class="tag drive" onclick="toggleTag(this)">Works Independently</div>
              <div class="tag drive" onclick="toggleTag(this)">Eager to Learn</div>
            </div>
          </div>

          <div class="section-label">Concrete Testing Skills</div>
          <div class="field">
            <div class="tag-group" id="skill-tags">
              <div class="tag" onclick="toggleTag(this)">Slump Testing</div>
              <div class="tag" onclick="toggleTag(this)">Air Content</div>
              <div class="tag" onclick="toggleTag(this)">Cylinder Making</div>
              <div class="tag" onclick="toggleTag(this)">Unit Weight</div>
              <div class="tag" onclick="toggleTag(this)">Compressive Strength</div>
              <div class="tag" onclick="toggleTag(this)">Sieve Analysis</div>
              <div class="tag" onclick="toggleTag(this)">Mix Design Review</div>
              <div class="tag" onclick="toggleTag(this)">Field Sampling</div>
              <div class="tag" onclick="toggleTag(this)">Temperature Testing</div>
              <div class="tag" onclick="toggleTag(this)">Report Writing</div>
            </div>
          </div>

          <div class="section-label">ACI Certifications</div>
          <div class="field">
            <div class="tag-group" id="skill-tags-aci">
              <div class="tag aci" onclick="toggleTag(this)">ACI Field Grade I</div>
              <div class="tag aci" onclick="toggleTag(this)">ACI Strength Testing</div>
              <div class="tag aci" onclick="toggleTag(this)">ACI Aggregate Testing</div>
            </div>
          </div>

          <button class="btn-primary" onclick="routePerson()">Find Best Projects ‚Üí</button>
        </div>
      </div>

      <!-- PROJECT TAB -->
      <div id="tab-project" class="tab-content">
        <div class="form-body">
          <div class="section-label">Project Details</div>
          <div class="field">
            <label>Project Name</label>
            <input type="text" id="p-name" placeholder="e.g. Riverway Bridge Deck">
          </div>
          <div class="field">
            <label>Description</label>
            <textarea id="p-desc" placeholder="Scope and key objectives..."></textarea>
          </div>
          <div class="field">
            <label>Location (City, State)</label>
            <input type="text" id="p-location" placeholder="e.g. Denver, CO">
          </div>
          <div class="field-row">
            <div><label>Start Date</label><input type="date" id="p-start"></div>
            <div><label>End Date</label><input type="date" id="p-end"></div>
          </div>
          <div class="field">
            <label>Projected Start <span style="color:var(--muted);font-size:0.55rem;letter-spacing:0.05em;text-transform:none;font-weight:400">(estimated)</span></label>
            <input type="text" id="p-projected" placeholder="e.g. Sometime in March, Mid-April, Q3 2026">
          </div>
          <div class="field">
            <label>Minimum Skill Level</label>
            <div class="slider-wrap">
              <div class="slider-row">
                <input type="range" id="p-skill" min="1" max="5" value="2" oninput="updateSlider(this)">
                <span class="slider-val" id="p-skill-val">2</span>
              </div>
              <div class="slider-labels"><span>Helping Out OK</span><span>Leading Project</span><span>No Help Needed</span></div>
            </div>
          </div>

          <div class="section-label">Suitable Positions</div>
          <div class="field">
            <div class="tag-group" id="p-positions">
              <div class="tag pos" onclick="toggleTag(this)">Lead Field Technician</div>
              <div class="tag pos" onclick="toggleTag(this)">Field Technician</div>
              <div class="tag pos" onclick="toggleTag(this)">Any</div>
            </div>
          </div>

          <div class="section-label">Ideal Drive &amp; Willingness</div>
          <div class="field">
            <div class="tag-group" id="p-personality">
              <div class="tag drive" onclick="toggleTag(this)">Self-Starter</div>
              <div class="tag drive" onclick="toggleTag(this)">Team Player</div>
              <div class="tag drive" onclick="toggleTag(this)">Takes Initiative</div>
              <div class="tag drive" onclick="toggleTag(this)">Follows Direction</div>
              <div class="tag drive" onclick="toggleTag(this)">Highly Motivated</div>
              <div class="tag drive" onclick="toggleTag(this)">Needs Guidance</div>
              <div class="tag drive" onclick="toggleTag(this)">Works Independently</div>
              <div class="tag drive" onclick="toggleTag(this)">Eager to Learn</div>
            </div>
          </div>

          <div class="section-label">Required Skills</div>
          <div class="field">
            <div class="tag-group" id="p-skills">
              <div class="tag" onclick="toggleTag(this)">Slump Testing</div>
              <div class="tag" onclick="toggleTag(this)">Air Content</div>
              <div class="tag" onclick="toggleTag(this)">Cylinder Making</div>
              <div class="tag" onclick="toggleTag(this)">Unit Weight</div>
              <div class="tag" onclick="toggleTag(this)">Compressive Strength</div>
              <div class="tag" onclick="toggleTag(this)">Sieve Analysis</div>
              <div class="tag" onclick="toggleTag(this)">Mix Design Review</div>
              <div class="tag" onclick="toggleTag(this)">Field Sampling</div>
              <div class="tag" onclick="toggleTag(this)">Temperature Testing</div>
              <div class="tag" onclick="toggleTag(this)">Report Writing</div>
            </div>
          </div>

          <div class="section-label">Required ACI Certifications</div>
          <div class="field">
            <div class="tag-group" id="p-skills-aci">
              <div class="tag aci" onclick="toggleTag(this)">ACI Field Grade I</div>
              <div class="tag aci" onclick="toggleTag(this)">ACI Strength Testing</div>
              <div class="tag aci" onclick="toggleTag(this)">ACI Aggregate Testing</div>
            </div>
          </div>

          <button class="btn-primary" onclick="addProject()">+ Add Project</button>
        </div>
      </div>
    </div><!-- /sidebar -->

    <!-- ‚îÄ‚îÄ‚îÄ RIGHT COLUMN ‚îÄ‚îÄ‚îÄ -->
    <div class="right-panel">

      <!-- RESULTS -->
      <div class="results-panel" id="results-panel">
        <div class="results-header">
          <div class="panel-heading">
            <div class="panel-heading-icon">üéØ</div>
            <div class="results-title">Match Results ‚Äî <span id="results-name"></span></div>
          </div>
        </div>
        <div class="results-body" id="results-list"></div>
      </div>

      <!-- MAP -->
      <div class="map-panel">
        <div class="map-header">
          <div class="panel-heading">
            <div class="panel-heading-icon">üìç</div>
            <div class="panel-heading-title">Deployment Map</div>
          </div>
          <div class="map-legend" id="map-legend">
            <span style="font-size:0.6rem;color:var(--muted)">No projects yet</span>
          </div>
        </div>
        <div id="us-map-wrap" style="position:relative;background:#f0f5fc;border-top:1.5px solid var(--border);aspect-ratio:960/580;">
          <svg id="us-svg" style="width:100%;height:100%;display:block;" xmlns="http://www.w3.org/2000/svg"></svg>
          <div id="map-tooltip">
            <div class="tt-proj" id="tt-proj"></div>
            <div class="tt-row"><span class="tt-key">Location</span><span class="tt-val" id="tt-loc"></span></div>
            <div class="tt-row"><span class="tt-key">Dates</span><span class="tt-val" id="tt-dates"></span></div>
            <div class="tt-row" id="tt-proj-row" style="display:none"><span class="tt-key">Est. Start</span><span class="tt-val" id="tt-projected"></span></div>
            <div class="tt-row"><span class="tt-key">Techs</span><span class="tt-val" id="tt-members"></span></div>
          </div>
          <div id="map-loading" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;pointer-events:none;">Loading map‚Ä¶</div>
        </div>
      </div>

      <!-- PROJECTS -->
      <div class="proj-panel">
        <div class="proj-panel-header">
          <div class="panel-heading">
            <div class="panel-heading-icon">üóÇ</div>
            <div class="panel-heading-title">Projects</div>
          </div>
          <div class="proj-count-badge" id="proj-count">3 Projects</div>
        </div>
        <div class="projects-grid" id="projects-grid"></div>
      </div>

      <!-- PEOPLE -->
      <div class="people-panel">
        <div class="people-panel-header">
          <div class="panel-heading">
            <div class="panel-heading-icon">üë∑</div>
            <div class="panel-heading-title">Deployed Technicians</div>
          </div>
          <div class="people-count-badge" id="people-count">0 Deployed</div>
        </div>
        <div class="people-body" id="people-list">
          <div class="empty">
            <div class="empty-icon">ü¶∫</div>
            <div class="empty-text">No technicians deployed yet.<br>Route someone to a project to see them here.</div>
          </div>
        </div>
      </div>

    </div><!-- /right-panel -->
  </div><!-- /layout -->
</div><!-- /app -->

<!-- Edit Modal -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-title">Edit Project</div>
    <div class="field"><label>Project Name</label><input type="text" id="edit-name"></div>
    <div class="field"><label>Description</label><textarea id="edit-desc"></textarea></div>
    <div class="field"><label>Location (City, State)</label><input type="text" id="edit-location" placeholder="e.g. Denver, CO"></div>
    <div class="field-row">
      <div><label>Start Date</label><input type="date" id="edit-start"></div>
      <div><label>End Date</label><input type="date" id="edit-end"></div>
    </div>
    <div class="field">
      <label>Projected Start <span style="color:var(--muted);font-size:0.55rem;letter-spacing:0.05em;text-transform:none;font-weight:400">(estimated)</span></label>
      <input type="text" id="edit-projected" placeholder="e.g. Sometime in March, Mid-April, Q3 2026">
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <span class="toast-icon" id="toast-icon">‚úì</span>
  <span class="toast-msg" id="toast-msg"></span>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
<script>
'use strict';

/******************************
 * STORAGE & DEFAULT DATA
 ******************************/
const STORAGE_KEYS = {
  projects: 'fieldops_projects_v1',
  people:  'fieldops_people_v1',
  nextId:  'fieldops_nextId_v1'
};

const DEFAULT_PROJECTS = [
  {id:1,name:'Riverway Bridge Deck',desc:'Structural deck pour with high-strength mix design.',location:'Denver, CO',startDate:'2026-03-10',endDate:'2026-05-20',projectedStart:'Sometime in March',skillMin:3,positions:['Lead Field Technician'],personality:['Takes Initiative','Works Independently'],skills:['Cylinder Making','Compressive Strength','ACI Field Grade I'],color:'#f5a623',members:[]},
  {id:2,name:'Southgate Foundation',desc:'Large mat foundation pour across multiple pours.',location:'Austin, TX',startDate:'2026-04-01',endDate:'2026-06-15',projectedStart:'Early April',skillMin:2,positions:['Field Technician','Lead Field Technician'],personality:['Team Player','Follows Direction','Eager to Learn'],skills:['Slump Testing','Air Content','Field Sampling'],color:'#2dd4a0',members:[]},
  {id:3,name:'Quarry QC Program',desc:'Aggregate gradation and source qualification testing.',location:'Atlanta, GA',startDate:'2026-05-05',endDate:'2026-08-30',projectedStart:'Q2 2026',skillMin:4,positions:['Lead Field Technician'],personality:['Self-Starter','Highly Motivated'],skills:['Sieve Analysis','ACI Aggregate Testing','ACI Strength Testing','Mix Design Review'],color:'#5b8df5',members:[]},
];

let projects = [];
let people = [];
let nextId = DEFAULT_PROJECTS.length + 1;

/******************************
 * SAVE / LOAD
 ******************************/
function saveState() {
  localStorage.setItem(STORAGE_KEYS.projects, JSON.stringify(projects));
  localStorage.setItem(STORAGE_KEYS.people, JSON.stringify(people));
  localStorage.setItem(STORAGE_KEYS.nextId, String(nextId));
}

function loadState() {
  try {
    const p = JSON.parse(localStorage.getItem(STORAGE_KEYS.projects) || 'null');
    const pe = JSON.parse(localStorage.getItem(STORAGE_KEYS.people) || 'null');
    const n = parseInt(localStorage.getItem(STORAGE_KEYS.nextId), 10);

    projects = Array.isArray(p) && p.length ? p : structuredClone(DEFAULT_PROJECTS);
    people   = Array.isArray(pe) ? pe : [];
    nextId   = Number.isInteger(n) ? n : DEFAULT_PROJECTS.length + 1;

  } catch (err) {
    console.error('Storage error ‚Äî reset defaults:', err);
    projects = structuredClone(DEFAULT_PROJECTS);
    people = [];
    nextId = DEFAULT_PROJECTS.length + 1;
  }
}

/******************************
 * HOOK INTO UI BEHAVIOR
 ******************************/
window.addEventListener('beforeunload', saveState);

loadState();  // initialize state on load

/******************************
 * OVERRIDES OF EXISTING FUNCTIONS
 *  ‚Äî now all mutate *then* save
 ******************************/
function addProject() {
  const name = document.getElementById('p-name').value.trim();
  if (!name) { toast('Enter a project name', false); return; }

  const proj = {
    id: nextId++, name,
    desc: document.getElementById('p-desc').value.trim() || 'No description.',
    location: document.getElementById('p-location').value.trim(),
    startDate: document.getElementById('p-start').value,
    endDate: document.getElementById('p-end').value,
    projectedStart: document.getElementById('p-projected').value.trim(),
    skillMin: +document.getElementById('p-skill').value,
    positions: getSel('p-positions'),
    personality: getSel('p-personality'),
    skills: [...getSel('p-skills'), ...getSel('p-skills-aci')],
    color: COLORS[(nextId - 2) % COLORS.length],
    members: []
  };
  projects.push(proj);

  saveState();  // ‚úî save now
  renderAll();
  toast(`"${name}" added to deployment board`);
  document.querySelectorAll('.tab')[0].click();
}

function deleteProject(id) {
  projects = projects.filter(p => p.id !== id);
  people = people.filter(p => p.projectId !== id);
  saveState();
  renderAll();
  toast('Project removed');
}

function saveEdit() {
  const p = projects.find(pr => pr.id === editingId);
  if (!p) return;
  p.name = document.getElementById('edit-name').value.trim() || p.name;
  p.desc = document.getElementById('edit-desc').value.trim() || p.desc;
  p.location = document.getElementById('edit-location').value.trim();
  p.startDate = document.getElementById('edit-start').value;
  p.endDate = document.getElementById('edit-end').value;
  p.projectedStart = document.getElementById('edit-projected').value.trim();
  people.filter(per => per.projectId === editingId).forEach(per => per.projectName = p.name);

  saveState();
  renderAll();
  closeModal();
  toast('Project updated');
}

function assignPerson(person, projId) {
  const proj = projects.find(p => p.id === projId);
  if (!proj) return;
  if (people.find(p => p.name === person.name && p.projectId === projId)) {
    toast(`${person.name} already on ${proj.name}`, false);
    return;
  }
  people = people.filter(p => p.name !== person.name);
  projects.forEach(pr => { pr.members = pr.members.filter(m => m !== person.name); });

  proj.members.push(person.name);
  people.push({
    ...person,
    projectId: projId,
    projectName: proj.name,
    color: proj.color
  });

  saveState();
  renderAll();
  toast(`${person.name} deployed to ${proj.name}`);
}

function resetData() {
  if (!confirm('Reset to sample projects and clear all assignments?')) return;
  projects = structuredClone(DEFAULT_PROJECTS);
  people = [];
  nextId = DEFAULT_PROJECTS.length + 1;

  saveState();
  renderAll();
  toast('Reset to defaults');
}

/******************************
 * INITIAL RENDER
 ******************************/
renderAll();
const COLORS = ['#f5a623','#2dd4a0','#5b8df5','#e84393','#a78bfa','#fb923c','#34d399','#f43f5e'];

function parseState(loc) {
  if (!loc) return null;
  const m = loc.trim().match(/,\s*([A-Za-z]{2})\s*$/);
  if (m) return m[1].toUpperCase();
  const map = {'alabama':'AL','alaska':'AK','arizona':'AZ','arkansas':'AR','california':'CA','colorado':'CO','connecticut':'CT','delaware':'DE','florida':'FL','georgia':'GA','hawaii':'HI','idaho':'ID','illinois':'IL','indiana':'IN','iowa':'IA','kansas':'KS','kentucky':'KY','louisiana':'LA','maine':'ME','maryland':'MD','massachusetts':'MA','michigan':'MI','minnesota':'MN','mississippi':'MS','missouri':'MO','montana':'MT','nebraska':'NE','nevada':'NV','new hampshire':'NH','new jersey':'NJ','new mexico':'NM','new york':'NY','north carolina':'NC','north dakota':'ND','ohio':'OH','oklahoma':'OK','oregon':'OR','pennsylvania':'PA','rhode island':'RI','south carolina':'SC','south dakota':'SD','tennessee':'TN','texas':'TX','utah':'UT','vermont':'VT','virginia':'VA','washington':'WA','west virginia':'WV','wisconsin':'WI','wyoming':'WY'};
  const low = loc.toLowerCase();
  for (const [n,a] of Object.entries(map)) { if (low.includes(n)) return a; }
  return null;
}

function fmtDate(d) {
  if (!d) return '‚Äî';
  const [y,m,day] = d.split('-');
  return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][+m-1]+' '+parseInt(day)+', '+y;
}

function fmtDateShort(d) {
  if (!d) return '‚Äî';
  const [y,m,day] = d.split('-');
  return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][+m-1]+' '+parseInt(day);
}

// ‚îÄ‚îÄ PERSISTENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveState() {
  try {
    localStorage.setItem('fieldops_projects', JSON.stringify(projects));
    localStorage.setItem('fieldops_people',   JSON.stringify(people));
    localStorage.setItem('fieldops_nextId',   String(nextId));
  } catch(e) {}
}
function loadState() {
  try {
    const p = localStorage.getItem('fieldops_projects');
    const pe = localStorage.getItem('fieldops_people');
    const n = localStorage.getItem('fieldops_nextId');
    if (p)  projects = JSON.parse(p);
    if (pe) people   = JSON.parse(pe);
    if (n)  nextId   = parseInt(n) || 4;
  } catch(e) {
    projects = DEFAULT_PROJECTS;
    people   = [];
    nextId   = 4;
  }
}
let editingId = null;
loadState();

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    document.getElementById('tab-' + this.dataset.tab).classList.add('active');
  });
});

function updateSlider(el) {
  const labels = ['','Helping Out','Helping Out','Leading Project','No Help Needed','No Help Needed'];
  document.getElementById(el.id + '-val').textContent = labels[el.value] || el.value;
}
function toggleTag(el) { el.classList.toggle('selected'); }
function getSel(id) { return [...document.querySelectorAll('#'+id+' .tag.selected')].map(t=>t.textContent.trim()); }

function addProject() {
  const name = document.getElementById('p-name').value.trim();
  if (!name) { toast('Enter a project name', false); return; }
  const proj = {
    id: nextId++, name,
    desc: document.getElementById('p-desc').value.trim() || 'No description.',
    location: document.getElementById('p-location').value.trim(),
    startDate: document.getElementById('p-start').value,
    endDate: document.getElementById('p-end').value,
    projectedStart: document.getElementById('p-projected').value.trim(),
    skillMin: +document.getElementById('p-skill').value,
    positions: getSel('p-positions'),
    personality: getSel('p-personality'),
    skills: [...getSel('p-skills'), ...getSel('p-skills-aci')],
    color: COLORS[(nextId-2) % COLORS.length],
    members: []
  };
  projects.push(proj);
  saveState();
  ['p-name','p-desc','p-location','p-start','p-end','p-projected'].forEach(id => document.getElementById(id).value='');
  document.getElementById('p-skill').value = 2;
  document.getElementById('p-skill-val').textContent = 'Helping Out';
  document.querySelectorAll('#p-positions .tag, #p-personality .tag, #p-skills .tag, #p-skills-aci .tag').forEach(t=>t.classList.remove('selected'));
  renderAll();
  toast(`"${name}" added to deployment board`);
  document.querySelectorAll('.tab')[0].click();
}

function skillLabel(n) {
  if (n <= 2) return 'Helping Out';
  if (n === 3) return 'Leading Project';
  return 'No Help Needed';
}

function scoreProject(proj, person) {
  let score = 0; const reasons = [];
  if (person.skill >= proj.skillMin) {
    score += 35;
    reasons.push(person.skill > proj.skillMin ? `Exceeds req (${skillLabel(person.skill)})` : `Meets req (${skillLabel(person.skill)})`);
  } else { reasons.push(`Below req ‚Äî needs ${skillLabel(proj.skillMin)}`); }
  const posOK = !proj.positions.length || proj.positions.includes('Any') || proj.positions.includes(person.position);
  if (posOK) { score += 30; if (person.position) reasons.push(`"${person.position}" fits`); }
  else reasons.push(`Position gap`);
  const pHits = person.personality.filter(t => proj.personality.includes(t));
  if (pHits.length) { score += Math.min(20, pHits.length*10); reasons.push(`Drive: ${pHits.join(', ')}`); }
  const sHits = person.skills.filter(s => proj.skills.includes(s));
  if (sHits.length) { score += Math.min(15, sHits.length*8); reasons.push(`Skills: ${sHits.slice(0,2).join(', ')}${sHits.length>2?'‚Ä¶':''}`); }
  return { score: Math.min(100, score), reasons };
}

function routePerson() {
  if (!projects.length) { toast('Add a project first', false); return; }
  const name = document.getElementById('r-name').value.trim();
  if (!name) { toast('Enter technician name', false); return; }
  const person = {
    name,
    position: document.getElementById('r-position').value,
    skill: +document.getElementById('r-skill').value,
    personality: getSel('personality-tags'),
    skills: [...getSel('skill-tags'), ...getSel('skill-tags-aci')],
  };
  const scored = projects.map(proj => ({proj,...scoreProject(proj,person)})).sort((a,b)=>b.score-a.score);
  document.getElementById('results-name').textContent = name;
  document.getElementById('results-list').innerHTML = scored.map((r,i) => {
    const cls = r.score>=75?'high':r.score>=45?'med':'low';
    const label = r.score>=75?'Strong Fit':r.score>=45?'Possible':'Low Fit';
    const meta = [r.proj.location&&`üìç ${r.proj.location}`,r.proj.startDate&&`üìÖ ${fmtDateShort(r.proj.startDate)} ‚Äì ${fmtDateShort(r.proj.endDate)}`,r.proj.projectedStart&&`‚è± Est. ${r.proj.projectedStart}`].filter(Boolean);
    return `<div class="result-item" style="animation-delay:${i*.07}s">
      <div class="match-badge ${cls}">
        <div class="match-pct">${r.score}%</div>
        <div class="match-label">${label}</div>
      </div>
      <div class="result-info">
        <div class="result-name">${r.proj.name}</div>
        <div class="result-reasons">${r.reasons.slice(0,2).join(' ¬∑ ')}</div>
        ${meta.length?`<div class="result-meta">${meta.map(m=>`<span>${m}</span>`).join('')}</div>`:''}
      </div>
      <button class="btn-assign" onclick='assignPerson(${JSON.stringify(person).replace(/'/g,"&#39;")},${r.proj.id})'>Deploy ‚Üí</button>
    </div>`;
  }).join('');
  document.getElementById('results-panel').classList.add('show');
}

function assignPerson(person, projId) {
  const proj = projects.find(p=>p.id===projId);
  if (!proj) return;
  if (people.find(p=>p.name===person.name&&p.projectId===projId)) { toast(`${person.name} already on ${proj.name}`,false); return; }
  people = people.filter(p=>p.name!==person.name);
  projects.forEach(pr=>{pr.members=pr.members.filter(m=>m!==person.name);});
  proj.members.push(person.name);
  people.push({...person,projectId:projId,projectName:proj.name,color:proj.color});
  saveState();
  renderAll();
  toast(`${person.name} deployed to ${proj.name}`);
}

function renderAll() {
  renderProjects(); renderPeople(); renderMap(); updateHeaderStats();
}

function updateHeaderStats() {
  document.getElementById('h-proj').textContent = projects.length;
  document.getElementById('h-people').textContent = people.length;
}

function renderProjects() {
  const grid = document.getElementById('projects-grid');
  document.getElementById('proj-count').textContent = `${projects.length} Project${projects.length!==1?'s':''}`;
  if (!projects.length) {
    grid.innerHTML = `<div class="empty" style="grid-column:1/-1"><div class="empty-icon">üèóÔ∏è</div><div class="empty-text">No projects yet.<br>Add your first project from the left panel.</div></div>`;
    return;
  }
  grid.innerHTML = projects.map(p => {
    const avatarHtml = p.members.slice(0,4).map((m,i)=>`<div class="avatar" style="background:${COLORS[(i+2)%COLORS.length]}">${m.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase()}</div>`).join('');
    const extra = p.members.length>4?`<span class="avatar-count">+${p.members.length-4}</span>`:'';
    const noMem = !p.members.length?`<span class="avatar-count" style="margin-left:0">Unassigned</span>`:'';
    return `<div class="project-card">
      <div class="card-stripe" style="background:${p.color}"></div>
      <div class="card-body">
        <div class="card-actions">
          <button class="icon-btn" onclick="openEdit(${p.id})" title="Edit">‚úé</button>
          <button class="icon-btn del" onclick="deleteProject(${p.id})" title="Delete">‚úï</button>
        </div>
        <div class="card-name">${p.name}</div>
        <div class="card-desc">${p.desc}</div>
        ${p.location?`<div class="card-info-row"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg><strong>${p.location}</strong></div>`:''}
        ${p.startDate?`<div class="card-info-row"><svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg><strong>${fmtDateShort(p.startDate)}</strong> ‚Äî <strong>${fmtDateShort(p.endDate)}</strong></div>`:''}
        ${p.projectedStart?`<div class="card-info-row" style="color:var(--amber);opacity:0.8"><svg viewBox="0 0 24 24" style="fill:currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm4.24 16L12 15.45 7.77 18l1.12-4.81-3.73-3.23 4.92-.42L12 5l1.92 4.53 4.92.42-3.73 3.23L16.23 18z"/></svg>Est. <strong>${p.projectedStart}</strong></div>`:''}
        <div class="card-chips">
          <span class="chip chip-level">${skillLabel(p.skillMin)}+</span>
          ${p.skills.slice(0,2).map(s=>`<span class="chip chip-skill">${s}</span>`).join('')}
          ${p.personality.slice(0,1).map(t=>`<span class="chip chip-trait">${t}</span>`).join('')}
        </div>
      </div>
      <div class="card-footer">
        <div class="avatars">${avatarHtml}${extra}${noMem}</div>
      </div>
    </div>`;
  }).join('');
}

function renderPeople() {
  const list = document.getElementById('people-list');
  document.getElementById('people-count').textContent = `${people.length} Deployed`;
  if (!people.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ü¶∫</div><div class="empty-text">No technicians deployed yet.<br>Route someone to a project above.</div></div>`;
    return;
  }
  list.innerHTML = people.map((p,i) => {
    const proj = projects.find(pr=>pr.id===p.projectId);
    const initials = p.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    return `<div class="person-row" style="animation-delay:${i*.05}s">
      <div class="person-avatar" style="background:${p.color}">${initials}</div>
      <div class="person-info">
        <div class="person-name">${p.name}</div>
        <div class="person-meta">${p.position||'‚Äî'} &nbsp;¬∑&nbsp; ${skillLabel(p.skill)}${proj?.location?` &nbsp;¬∑&nbsp; üìç ${proj.location}`:''}</div>
      </div>
      <div class="person-right">
        <div class="person-proj-tag">${p.projectName}</div>
        ${proj?.startDate?`<div class="person-date-tag">üìÖ ${fmtDateShort(proj.startDate)} ‚Äì ${fmtDateShort(proj.endDate)}</div>`:''}
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ D3 + TOPOJSON MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MAP_W = 960, MAP_H = 580;
const NS = 'http://www.w3.org/2000/svg';

// FIPS numeric id ‚Üí state abbreviation
const FIPS = {"01":"AL","02":"AK","04":"AZ","05":"AR","06":"CA","08":"CO","09":"CT","10":"DE","12":"FL","13":"GA","15":"HI","16":"ID","17":"IL","18":"IN","19":"IA","20":"KS","21":"KY","22":"LA","23":"ME","24":"MD","25":"MA","26":"MI","27":"MN","28":"MS","29":"MO","30":"MT","31":"NE","32":"NV","33":"NH","34":"NJ","35":"NM","36":"NY","37":"NC","38":"ND","39":"OH","40":"OK","41":"OR","42":"PA","44":"RI","45":"SC","46":"SD","47":"TN","48":"TX","49":"UT","50":"VT","51":"VA","53":"WA","54":"WV","55":"WI","56":"WY"};

let d3Projection = null;   // set after TopoJSON loads
let pinsLayerEl = null;

// State lat/lon centroids for pin placement
const STATE_LL = {
  AL:[-86.8,32.8],AK:[-153.4,63.4],AZ:[-111.1,34.0],AR:[-92.4,34.9],CA:[-119.4,37.2],
  CO:[-105.5,39.1],CT:[-72.7,41.6],DE:[-75.5,39.1],FL:[-81.5,27.7],GA:[-83.4,32.2],
  HI:[-155.9,19.9],ID:[-114.7,44.1],IL:[-89.2,40.3],IN:[-86.3,39.8],IA:[-93.2,42.0],
  KS:[-98.3,38.5],KY:[-84.7,37.7],LA:[-92.0,31.2],ME:[-69.4,44.7],MD:[-76.8,39.0],
  MA:[-71.5,42.2],MI:[-84.6,43.3],MN:[-94.7,46.4],MS:[-89.7,32.7],MO:[-92.3,38.5],
  MT:[-110.4,46.9],NE:[-99.9,41.5],NV:[-116.4,38.8],NH:[-71.6,43.2],NJ:[-74.4,40.1],
  NM:[-105.9,34.5],NY:[-75.0,43.3],NC:[-79.8,35.8],ND:[-101.0,47.6],OH:[-82.9,40.4],
  OK:[-96.9,35.6],OR:[-120.6,43.8],PA:[-77.2,41.2],RI:[-71.5,41.7],SC:[-80.9,33.8],
  SD:[-99.4,44.3],TN:[-86.7,35.7],TX:[-99.3,31.1],UT:[-111.1,39.3],VT:[-72.7,44.6],
  VA:[-78.7,37.4],WA:[-120.7,47.8],WV:[-80.5,38.5],WI:[-89.7,44.3],WY:[-107.6,43.1]
};

// Build the map once on page load
(function initMap() {
  const svgEl = document.getElementById('us-svg');
  svgEl.setAttribute('viewBox', `0 0 ${MAP_W} ${MAP_H}`);
  svgEl.setAttribute('preserveAspectRatio', 'xMidYMid meet');

  const projection = d3.geoAlbersUsa().scale(1280).translate([MAP_W/2, MAP_H/2]);
  d3Projection = projection;
  const path = d3.geoPath().projection(projection);

  const svg = d3.select(svgEl);
  const statesG = svg.append('g').attr('id','states-layer');
  pinsLayerEl  = svg.append('g').attr('id','pins-layer').node();
  const labelsG = svg.append('g').attr('id','labels-layer');

  fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json')
    .then(r => r.json())
    .then(us => {
      const features = topojson.feature(us, us.objects.states).features;
      const borders  = topojson.mesh(us, us.objects.states, (a,b) => a !== b);
      const outline  = topojson.mesh(us, us.objects.states, (a,b) => a === b);

      // State fills
      statesG.selectAll('path')
        .data(features)
        .enter().append('path')
        .attr('d', path)
        .attr('fill', '#dce9f8')
        .attr('stroke', 'none')
        .style('transition','fill 0.15s')
        .on('mouseover', function() { d3.select(this).attr('fill','#c5daf0'); })
        .on('mouseout',  function() { d3.select(this).attr('fill','#dce9f8'); });

      // Interior borders
      statesG.append('path').datum(borders)
        .attr('d', path).attr('fill','none')
        .attr('stroke','#b0c4d8').attr('stroke-width','0.7');

      // Outer coastline
      statesG.append('path').datum(outline)
        .attr('d', path).attr('fill','none')
        .attr('stroke','#8aaabf').attr('stroke-width','1.2');

      // State abbreviation labels at centroid
      features.forEach(feat => {
        const abbr = FIPS[String(feat.id).padStart(2,'0')];
        if (!abbr) return;
        const c = path.centroid(feat);
        if (!c || isNaN(c[0]) || isNaN(c[1])) return;
        labelsG.append('text')
          .attr('x', c[0]).attr('y', c[1]+3)
          .attr('text-anchor','middle')
          .attr('font-size', abbr.length > 2 ? 6 : 7.5)
          .attr('font-family','Share Tech Mono,monospace')
          .attr('fill','#7a99b5')
          .attr('pointer-events','none')
          .text(abbr);
      });

      // Hide loading indicator
      const loader = document.getElementById('map-loading');
      if (loader) loader.style.display = 'none';

      // Draw pins now that projection is ready
      drawPins();
    })
    .catch(() => {
      const loader = document.getElementById('map-loading');
      if (loader) loader.textContent = 'Map requires internet connection';
    });
})();

function drawPins() {
  if (!pinsLayerEl) return;
  d3.select(pinsLayerEl).selectAll('*').remove();

  const byState = {};
  projects.forEach(proj => {
    const abbr = parseState(proj.location);
    if (!abbr || !STATE_LL[abbr] || !d3Projection) return;
    if (!byState[abbr]) byState[abbr] = [];
    byState[abbr].push(proj);
  });

  Object.entries(byState).forEach(([abbr, projs]) => {
    const pt = d3Projection(STATE_LL[abbr]);
    if (!pt) return;
    projs.forEach((proj, idx) => {
      const n = projs.length;
      const cx = pt[0] + (n > 1 ? (idx - (n-1)/2) * 22 : 0);
      const cy = pt[1];
      const staffed = proj.members.length > 0;
      const r = staffed ? 11 : 8;
      const g = d3.select(pinsLayerEl).append('g').attr('class','map-pin').style('cursor','pointer');

      if (staffed) g.append('circle').attr('cx',cx).attr('cy',cy).attr('r',r+7)
        .attr('fill',proj.color).attr('opacity',0.22).attr('class','pin-pulse');

      g.append('circle').attr('cx',cx).attr('cy',cy+2).attr('r',r+3)
        .attr('fill',proj.color).attr('opacity',0.18);
      g.append('circle').attr('cx',cx).attr('cy',cy).attr('r',r)
        .attr('fill',proj.color).attr('opacity',0.93).attr('class','pin-main');
      g.append('circle').attr('cx',cx).attr('cy',cy).attr('r',r-3)
        .attr('fill','none').attr('stroke','rgba(255,255,255,0.3)').attr('stroke-width',1.2);

      if (proj.members.length) {
        g.append('text').attr('x',cx).attr('y',cy+3.5)
          .attr('text-anchor','middle').attr('font-size',9).attr('font-weight',700)
          .attr('fill','#f0f5fc').attr('font-family','Barlow Condensed,sans-serif')
          .attr('pointer-events','none').text(proj.members.length);
      }

      g.on('mouseenter', e => {
        document.getElementById('tt-proj').textContent = proj.name;
        document.getElementById('tt-proj').style.color = proj.color;
        document.getElementById('tt-loc').textContent = proj.location||'Not set';
        document.getElementById('tt-dates').textContent = proj.startDate
          ? `${fmtDate(proj.startDate)} ‚Äì ${fmtDate(proj.endDate)}` : 'Dates not set';
        const projRow = document.getElementById('tt-proj-row');
        if (proj.projectedStart) {
          document.getElementById('tt-projected').textContent = proj.projectedStart;
          projRow.style.display = 'flex';
        } else { projRow.style.display = 'none'; }
        document.getElementById('tt-members').textContent = proj.members.length
          ? proj.members.join(', ') : 'None assigned';
        document.getElementById('map-tooltip').style.display='block';
        moveTT(e);
      }).on('mousemove', moveTT)
        .on('mouseleave', () => { document.getElementById('map-tooltip').style.display='none'; });
    });
  });
}

if (d3Projection) drawPins();
function renderMap() {
  const legend = document.getElementById('map-legend');
  if (!projects.length) {
    legend.innerHTML = `<span style="font-size:0.6rem;color:var(--muted)">No projects yet</span>`;
    if (pinsLayerEl) d3.select(pinsLayerEl).selectAll('*').remove();
    return;
  }
  legend.innerHTML = projects.map(p =>
    `<div class="legend-item"><div class="legend-dot" style="background:${p.color}"></div>${p.name}</div>`
  ).join('');
}

function moveTT(e) {
  const wrap = document.getElementById('us-map-wrap');
  const rect = wrap.getBoundingClientRect();
  const tt = document.getElementById('map-tooltip');
  let x = e.clientX-rect.left+14, y = e.clientY-rect.top-10;
  if (x+260>rect.width) x = e.clientX-rect.left-266;
  if (y+140>rect.height) y = e.clientY-rect.top-140;
  tt.style.left=Math.max(4,x)+'px'; tt.style.top=Math.max(4,y)+'px';
}

function deleteProject(id) {
  projects=projects.filter(p=>p.id!==id);
  people=people.filter(p=>p.projectId!==id);
  saveState();
  renderAll(); toast('Project removed');
}

function openEdit(id) {
  editingId=id;
  const p=projects.find(pr=>pr.id===id);
  document.getElementById('edit-name').value=p.name;
  document.getElementById('edit-desc').value=p.desc;
  document.getElementById('edit-location').value=p.location||'';
  document.getElementById('edit-start').value=p.startDate||'';
  document.getElementById('edit-end').value=p.endDate||'';
  document.getElementById('edit-projected').value=p.projectedStart||'';
  document.getElementById('edit-modal').classList.add('open');
}
function closeModal(){ document.getElementById('edit-modal').classList.remove('open'); }
function saveEdit(){
  const p=projects.find(pr=>pr.id===editingId);
  p.name=document.getElementById('edit-name').value.trim()||p.name;
  p.desc=document.getElementById('edit-desc').value.trim()||p.desc;
  p.location=document.getElementById('edit-location').value.trim();
  p.startDate=document.getElementById('edit-start').value;
  p.endDate=document.getElementById('edit-end').value;
  p.projectedStart=document.getElementById('edit-projected').value.trim();
  people.filter(per=>per.projectId===editingId).forEach(per=>per.projectName=p.name);
  saveState();
  renderAll(); closeModal(); toast('Project updated');
}

document.getElementById('edit-modal').addEventListener('click',e=>{ if(e.target===document.getElementById('edit-modal')) closeModal(); });

function resetData() {
  if (!confirm('Reset to sample projects and clear all assignments?')) return;
  projects = JSON.parse(JSON.stringify(DEFAULT_PROJECTS));
  people = [];
  nextId = 4
  saveState();
  renderAll();
  toast('Reset to defaults');
}
  
function toast(msg, ok=true) {
  const t=document.getElementById('toast');
  t.style.borderLeft=`3px solid ${ok?'var(--green)':'var(--red)'}`;
  document.getElementById('toast-icon').textContent=ok?'‚úì':'‚ö†';
  document.getElementById('toast-icon').style.color=ok?'var(--green)':'var(--red)';
  document.getElementById('toast-msg').textContent=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3200);
}

window.addEventListener('beforeunload', saveState);

// Initialize slider label text
['r-skill','p-skill'].forEach(id => {
  const el = document.getElementById(id);
  if (el) updateSlider(el);
});

// üîë THIS IS THE KEY PART
loadState(); {
renderAll();
}
</script>
</body>
</html>
